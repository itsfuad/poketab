let socket=io(),pop=new Audio("./../sounds/pop.wav"),juntos=new Audio("./../sounds/juntos.wav"),elegant=new Audio("./../sounds/elegant.wav"),typing_sound=new Audio("./../sounds/typing.wav"),myname,myid;const appHeight=()=>{const doc=document.documentElement;doc.style.setProperty("--app-height",`${window.innerHeight}px`)};window.addEventListener("resize",appHeight),appHeight();let scrolling=!1;function updateScroll(){if(scrolling)return;let element=document.getElementById("messages");element.scrollTop=element.scrollHeight}function scrollToBottom(){let messages=$("#messages"),newMessage=messages.children("li:last-child"),clientHeight=messages.prop("clientHeight"),scrollTop=messages.prop("scrollTop"),scrollHeight=messages.prop("scrollHeight"),newMessageHeight,lastMessageHeight;clientHeight+scrollTop+newMessage.innerHeight()+newMessage.prev().innerHeight()>=scrollHeight&&messages.scrollTop(scrollHeight)}window.onscroll=e=>{scrolling=!0,setTimeout(()=>{scrolling=!1},2e3)},socket.on("connect",(function(){let params=$.deparam(window.location.search);console.log("Connected to server"),elegant.play(),socket.emit("join",params,(function(err){err?"empty"==err?window.location.href="/?NR_0":"exists"==err?window.location.href="/?UE_1":"avatar"==err&&(window.location.href="/?NA_0"):console.log("No error")})),$("#main-screen").css("visibility","visible"),$("#preloader").css("visibility","hidden")})),socket.on("disconnect",(function(){console.log("Disconnected from server")})),socket.on("updateUserList",(function(users,ids,key,avatars){let ol=$("<ul></ul>");for(let i=0;i<users.length;i++)ol.append($(`<li class='user' id='${ids[i]}'></li>`).html(`<img height='30px' width='30px' src='images/avatars/${avatars[i]}(custom).png'> ${users[i]}`));$(".menu").text(`Online: ${users.length}`),$(".keyname1").text(`${key}`),$(".keyname2").text(`${key}`),$(".users").html(ol)})),socket.on("newMessage",(function(message,avatar,isReply,replyTo,replyText,id,targetId){elegant.play();let formattedTime=moment(message.createdAt).format("h:mm a"),template,html;isReply?(replyTo==myname&&(replyTo="You"),template=$("#message-template").html(),html=Mustache.render(template,{text:linkify(message.text),from:`${message.from} replied to ${replyTo}`,reply:replyText,id:id,repId:targetId,repIcon:"<img src='./../images/reply-blue.png' height='10px' width='10px' class='rep-icon'> ",createdAt:formattedTime,attr:"style",replyMessageStyle:"display: block; transform: translateY(20px);",messageTitleStyle:"transform: translateY(20px)",attrVal:`images/avatars/${avatar}(custom).png`})):(template=$("#message-template").html(),html=Mustache.render(template,{text:linkify(message.text),from:message.from,id:id,attr:"style",replyMessageStyle:"display: none; transform: translateY(0px);",messageTitleStyle:"transform: translateY(0px)",createdAt:formattedTime,attrVal:`images/avatars/${avatar}(custom).png`})),html=html.replace(/¶/g,"<br>"),$("#messages").append(html),emo_test(message.text)&&$("#messages li:last div p").css({background:"none","font-size":"30px",padding:"0px"}),closePopup(),updateScroll()})),socket.on("my__message",(function(message,avatar,isReply,replyTo,replyText,id,targetId){pop.play();let formattedTime=moment(message.createdAt).format("h:mm a"),template,html;isReply?(replyTo==myname&&(replyTo="You"),template=$("#my-message-template").html(),html=Mustache.render(template,{text:linkify(message.text),from:`You replied to ${replyTo}`,id:id,repId:targetId,reply:replyText,repIcon:"<img src='./../images/reply-blue.png' height='10px' width='10px' class='rep-icon'> ",createdAt:formattedTime,attr:"style",replyMessageStyle:"display: block; transform: translateY(20px);",messageTitleStyle:"display: block; transform: translateY(20px)",attrVal:`images/avatars/${avatar}(custom).png`})):(template=$("#my-message-template").html(),html=Mustache.render(template,{text:linkify(message.text),from:message.from,id:id,attr:"style",replyMessageStyle:"display: none; transform: translateY(0px);",messageTitleStyle:"display: none; transform: translateY(0px)",createdAt:formattedTime,attrVal:`images/avatars/${avatar}(custom).png`})),html=html.replace(/¶/g,"<br>"),$("#messages").append(html),emo_test(message.text)&&$("#messages li:last div p").css({background:"none","font-size":"30px",padding:"0px"}),closePopup(),updateScroll()})),socket.on("server_message",(function(message,name=null,id=null){myname=name||myname,myid=id||myid,juntos.play();let formattedTime=moment(message.createdAt).format("h:mm a"),template=$("#server-message-template").html(),html=Mustache.render(template,{text:message.text,from:message.from,createdAt:formattedTime});message.text.includes("joined")&&(html=html.replace(/<p>/g,"<p style='color: limegreen;'>")),html=message.text.includes("left")?html.replace(/<p>/g,"<p style='color: orangered;'>"):html.replace(/<p>/g,"<p style='color: var(--blue);'>"),$("#messages").append(html),updateScroll()})),socket.on("newLocationMessage",(function(message){let formattedTime=moment(message.createdAt).format("h:mm a"),template=$("#location-message-template").html(),html=Mustache.render(template,{from:message.from,url:message.url,createdAt:formattedTime});pop.play(),$("#messages").append(html),updateScroll()})),socket.on("typing",(user,id)=>{let li=$(`<li id="${id}"></li>`).text(user+" is typing...");$("#typingindicator").append(li),updateScroll()}),socket.on("stoptyping",id=>{$(`#${id}`).remove()}),socket.on("vibrateResponse",(sender_name,id)=>{id==myid&&(sender_name==myname&&(sender_name="You"),$(".popup-message").text(`${sender_name} just vibrated your Device`),$(".popup-message").fadeIn(500),navigator.vibrate(1e3),setTimeout((function(){$(".popup-message").fadeOut(500)}),1e3))}),$("#message-form").on("submit",(function(e){e.preventDefault();let messageTextbox=$("[name=message]"),text=messageTextbox.val();messageTextbox.val(""),text.length>1e4&&(text=text.substring(0,1e4)),0!=text.replace(/\n/g,"").replace(/ /g,"").length?(text=text.trim(),text=text.replace(/\n/g,"¶"),typing=!1,socket.emit("stoptyping"),socket.emit("createMessage",{text:text},isReply,replyTo,replyText,targetId,(function(){$("#textbox").css("height","auto")})),$("#textbox").css("height","auto"),closePopup()):$("#textbox").css("height","auto")}));let locationButton=$("#send-location");locationButton.on("click",(function(){if(!navigator.geolocation)return alert("Geolocation not supported by your browser.");locationButton.attr("disabled","disabled").html('<img id="sendlocation" height=\'25px\' width="25px" src="./images/icons8-gps-48.png" alt="" srcset="">'),navigator.geolocation.getCurrentPosition((function(position){locationButton.removeAttr("disabled").html('<img id="sendlocation" height=\'25px\' width="25px" src="./images/icons8-gps-48.png" alt="" srcset="">'),socket.emit("createLocationMessage",{latitude:position.coords.latitude,longitude:position.coords.longitude})}),(function(){locationButton.removeAttr("disabled").html('<img id="sendlocation" height=\'25px\' width="25px" src="./images/icons8-gps-48.png" alt="" srcset="">'),alert("Unable to fetch location.")}))}));let typing=!1,timeout=void 0;function closePopup(){isReply=!1,$(".toast-popup").hide(),$(".toast-popup-name").text(""),$(".toast-popup-message").text("")}$("#textbox").on("keydown",(function(){timeout&&(clearTimeout(timeout),timeout=void 0),typing||(typing=!0,socket.emit("typing")),timeout=setTimeout((function(){typing=!1,socket.emit("stoptyping")}),1e3)})),$(".menu").on("click",(function(){$(".menuwrapper").addClass("active")})),$(".chat").on("click",(function(){$(".menuwrapper").removeClass("active")})),$("#textbox").on("focus",(function(){updateScroll()})),$(".toast-popup-close").on("click",()=>{closePopup()});let isReply=!1,replyTo,replyText,targetId;function linkify(inputText){var replacedText,replacePattern1,replacePattern2,replacePattern3;return replacePattern1=/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,replacePattern2=/(^|[^\/])(www\.[\S]+(\b|$))/gim,replacePattern3=/(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim,replacedText=(replacedText=(replacedText=inputText.replace(replacePattern1,'<a href="$1" target="_blank">$1</a>')).replace(replacePattern2,'$1<a href="http://$2" target="_blank">$2</a>')).replace(replacePattern3,'<a href="mailto:$1">$1</a>')}$("#messages").on("click",(function(evt){let target=evt.target;if("textMessage"===target.className){targetId=target.parentElement.parentElement.parentElement.id,replyText=`${target.innerText.substring(0,300)}...`,replyTo=evt.target.parentElement.previousElementSibling.previousElementSibling.innerText,replyTo=replyTo.replace(/ replied to [a-zA-Z]+/g,"");let replyToPop=replyTo;replyToPop==myname&&(replyToPop="You"),"You"==replyTo&&(replyTo=myname),isReply=!0,$(".toast-popup").show(),$(".toast-popup-name").text(`Replying to ${replyToPop}`),$(".toast-popup-message").text(`${target.innerText.substring(0,100)}`),$("#textbox").focus()}else if(target.className.includes("replyMessage")){const msgId=target.dataset.repid,element=document.getElementById(msgId);element.scrollIntoView({block:"center"}),$("#messages .my__message").css("filter","brightness(0.5)"),$("#messages .message").css("filter","brightness(0.5)"),$(`#${msgId}`).css("filter","initial"),setTimeout((function(){$("#messages .my__message").css("filter",""),$("#messages .message").css("filter",""),$(`#${msgId}`).css("filter","")}),1e3)}})),$(".users").on("click",(function(evt){evt.preventDefault(),console.log("clicked on users");let target=evt.target;if("user"===target.className){let targetId=target.id;socket.emit("vibrate",myname,targetId),targetId!==myid&&($(".popup-message").text(`You just vibrated ${target.innerText}'s Device`),$(".popup-message").fadeIn(500),setTimeout((function(){$(".popup-message").fadeOut(500)}),1e3))}})),window.addEventListener("resize",()=>{updateScroll()}),$(".send").on("focus",(function(){$("#textbox").focus()})),$("textarea").each((function(){this.setAttribute("style","height:"+this.scrollHeight+"px;overflow-y:hidden;")})).on("input",(function(){this.style.height="auto",this.style.height=this.scrollHeight+"px"}));var emoji_regex=/^(?:[\u2700-\u27bf]|(?:\ud83c[\udde6-\uddff]){2}|[\ud800-\udbff][\udc00-\udfff]|[\u0023-\u0039]\ufe0f?\u20e3|\u3299|\u3297|\u303d|\u3030|\u24c2|\ud83c[\udd70-\udd71]|\ud83c[\udd7e-\udd7f]|\ud83c\udd8e|\ud83c[\udd91-\udd9a]|\ud83c[\udde6-\uddff]|[\ud83c[\ude01-\ude02]|\ud83c\ude1a|\ud83c\ude2f|[\ud83c[\ude32-\ude3a]|[\ud83c[\ude50-\ude51]|\u203c|\u2049|[\u25aa-\u25ab]|\u25b6|\u25c0|[\u25fb-\u25fe]|\u00a9|\u00ae|\u2122|\u2139|\ud83c\udc04|[\u2600-\u26FF]|\u2b05|\u2b06|\u2b07|\u2b1b|\u2b1c|\u2b50|\u2b55|\u231a|\u231b|\u2328|\u23cf|[\u23e9-\u23f3]|[\u23f8-\u23fa]|\ud83c\udccf|\u2934|\u2935|[\u2190-\u21ff])+$/;function emo_test(str){return emoji_regex.test(str)}